        // Update content
        icon.className = iconClass;
        titleEl.textContent = title;
        messageEl.textContent = message;
        toast.querySelector('.notification').className = `notification bg-white rounded-xl shadow-xl p-4 max-w-sm border-l-4 ${borderColor}`;
        
        // Show notification
        toast.classList.remove('hidden');
        
        // Auto hide after 4 seconds
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 4000);
    }

    // ==================== SAMPLE DATA GENERATION (FOR TESTING) ====================
    function addSampleOrders() {
        if (!isFirebaseConnected) {
            showNotification('error', 'Database Error', 'Cannot add sample data');
            return;
        }
        
        const sampleOrders = [
            {
                orderId: "ORD-" + Date.now().toString().slice(-6),
                customerName: "Rajesh Kumar",
                customerPhone: "+919876543210",
                customerEmail: "rajesh@example.com",
                items: [
                    { name: "Paneer Butter Masala", quantity: 2, price: 220, pack: "Family Pack" },
                    { name: "Garlic Naan", quantity: 4, price: 40, pack: "Standard" },
                    { name: "Coke", quantity: 2, price: 60, pack: "1.25L" }
                ],
                totalAmount: 660,
                deliveryMode: "delivery",
                address: "123 MG Road, Indore, MP 452001",
                paymentMethod: "Razorpay",
                paymentId: "pay_" + Math.random().toString(36).substr(2, 9),
                status: "pending",
                otp: "123456",
                createdAt: Date.now() - 300000, // 5 minutes ago
                updatedAt: Date.now() - 300000
            },
            {
                orderId: "ORD-" + (Date.now() + 1000).toString().slice(-6),
                customerName: "Priya Sharma",
                customerPhone: "+919876543211",
                customerEmail: "priya@example.com",
                items: [
                    { name: "Veg Biryani", quantity: 1, price: 180, pack: "Standard" },
                    { name: "Raita", quantity: 1, price: 40, pack: "Standard" },
                    { name: "Chocolate Lava Cake", quantity: 2, price: 120, pack: "Standard" }
                ],
                totalAmount: 340,
                deliveryMode: "takeaway",
                address: "Takeaway - Prime Square, Indore",
                paymentMethod: "Razorpay",
                paymentId: "pay_" + Math.random().toString(36).substr(2, 9),
                status: "preparing",
                otp: "654321",
                createdAt: Date.now() - 600000, // 10 minutes ago
                updatedAt: Date.now() - 120000
            }
        ];
        
        sampleOrders.forEach(async (order) => {
            try {
                const newOrderRef = database.ref('orders').push();
                await newOrderRef.set(order);
                console.log("Sample order added:", order.orderId);
            } catch (error) {
                console.error("Error adding sample order:", error);
            }
        });
        
        showNotification('success', 'Sample Data Added', '2 sample orders added to database');
    }

    // ==================== DATA EXPORT ====================
    async function exportOrdersData() {
        if (!isFirebaseConnected) {
            showNotification('error', 'Database Error', 'Cannot export data');
            return;
        }
        
        try {
            const snapshot = await database.ref('orders').once('value');
            const orders = snapshot.val();
            
            if (!orders) {
                showNotification('warning', 'No Data', 'No orders to export');
                return;
            }
            
            // Convert to CSV
            let csv = 'Order ID, Customer Name, Phone, Amount, Status, Delivery Mode, Payment Method, Created At\n';
            
            Object.entries(orders).forEach(([id, order]) => {
                const date = new Date(order.createdAt).toLocaleString();
                csv += `"${order.orderId || id}","${order.customerName || ''}","${order.customerPhone || ''}",${order.totalAmount || 0},"${order.status || ''}","${order.deliveryMode || ''}","${order.paymentMethod || ''}","${date}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `easygo-orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('success', 'Export Complete', 'Orders data exported as CSV');
            
        } catch (error) {
            console.error("Error exporting data:", error);
            showNotification('error', 'Export Failed', 'Could not export data');
        }
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        // Check if admin is already logged in
        const isLoggedIn = localStorage.getItem('easygo-admin-logged-in') === 'true';
        
        if (isLoggedIn) {
            // Auto login
            currentAdmin = {
                name: localStorage.getItem('easygo-admin-name') || 'Admin User'
            };
            
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            
            // Initialize Firebase
            initializeFirebase();
            
            // Setup dashboard
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Show loading notification
            setTimeout(() => {
                if (isFirebaseConnected) {
                    setupOrderListeners();
                    loadActiveOrders();
                    loadOrderHistory();
                    updateStats();
                } else {
                    // Retry after 2 seconds
                    setTimeout(() => {
                        if (database) {
                            setupOrderListeners();
                            loadActiveOrders();
                            loadOrderHistory();
                            updateStats();
                        }
                    }, 2000);
                }
            }, 1000);
            
        } else {
            // Show login screen
            document.getElementById('admin-pin').focus();
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + L to logout
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                logoutAdmin();
            }
            
            // Esc to close modals
            if (e.key === 'Escape') {
                closeDeliveryModal();
                closeCancelModal();
                closeDetailsModal();
                closeWhatsAppModal();
            }
            
            // Ctrl + R to refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                loadActiveOrders();
                loadOrderHistory();
                updateStats();
                showNotification('info', 'Refreshed', 'Data refreshed successfully');
            }
        });
        
        // Focus PIN field on page load
        document.getElementById('admin-pin')?.focus();
    });

    // ==================== DEBUG FUNCTIONS ====================
    // For testing - add a test button to the UI
    function addTestButton() {
        const header = document.querySelector('.flex.justify-between.items-start');
        if (header) {
            const testDiv = document.createElement('div');
            testDiv.className = 'flex items-center gap-2';
            testDiv.innerHTML = `
                <button onclick="addSampleOrders()" 
                        class="px-4 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition-colors font-bold shadow text-sm">
                    <i class="fas fa-vial mr-2"></i> Add Test Orders
                </button>
                <button onclick="exportOrdersData()" 
                        class="px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors font-bold shadow text-sm">
                    <i class="fas fa-download mr-2"></i> Export CSV
                </button>
            `;
            header.appendChild(testDiv);
        }
    }
    
    // Call this after dashboard loads
    setTimeout(addTestButton, 2000);

    // ==================== ERROR HANDLING ====================
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
        showNotification('error', 'Application Error', 'Something went wrong. Please refresh.');
    });

    // Prevent accidental refresh
    window.addEventListener('beforeunload', function(e) {
        if (currentAdmin) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });

    // ==================== PUBLIC FUNCTIONS ====================
    // Make functions available globally
    window.loginAdmin = loginAdmin;
    window.logoutAdmin = logoutAdmin;
    window.filterOrders = filterOrders;
    window.selectOrder = selectOrder;
    window.clearSelectedOrder = clearSelectedOrder;
    window.updateSelectedOrderStatus = updateSelectedOrderStatus;
    window.showDeliveryModal = showDeliveryModal;
    window.closeDeliveryModal = closeDeliveryModal;
    window.confirmDelivery = confirmDelivery;
    window.showCancelModal = showCancelModal;
    window.closeCancelModal = closeCancelModal;
    window.confirmCancel = confirmCancel;
    window.notifyCustomer = notifyCustomer;
    window.sendWhatsAppNow = sendWhatsAppNow;
    window.closeWhatsAppModal = closeWhatsAppModal;
    window.viewOrderDetails = viewOrderDetails;
    window.closeDetailsModal = closeDetailsModal;
    window.loadOrderHistory = loadOrderHistory;
    window.addSampleOrders = addSampleOrders;
    window.exportOrdersData = exportOrdersData;
</script>

<!-- Add test buttons to dashboard -->
<script>
    // Add test buttons after dashboard loads
    setTimeout(() => {
        const quickActions = document.querySelector('.space-y-8');
        if (quickActions) {
            const testCard = document.createElement('div');
            testCard.className = 'bg-white rounded-2xl shadow-lg p-6 border border-gray-100';
            testCard.innerHTML = `
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-flask text-purple-500"></i>
                    Developer Tools
                </h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="addSampleOrders()" 
                            class="p-3 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 transition-colors">
                        <i class="fas fa-vial mr-2"></i>Add Test Orders
                    </button>
                    <button onclick="exportOrdersData()" 
                            class="p-3 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button onclick="clearAllOrders()" 
                            class="p-3 bg-red-100 text-red-700 rounded-xl hover:bg-red-200 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                    <button onclick="testNotification()" 
                            class="p-3 bg-yellow-100 text-yellow-700 rounded-xl hover:bg-yellow-200 transition-colors">
                        <i class="fas fa-bell mr-2"></i>Test Notify
                    </button>
                </div>
            `;
            quickActions.appendChild(testCard);
        }
    }, 3000);
    
    // Additional test functions
    async function clearAllOrders() {
        if (!confirm('Are you sure you want to delete ALL orders? This cannot be undone!')) {
            return;
        }
        
        try {
            await database.ref('orders').remove();
            showNotification('success', 'Database Cleared', 'All orders have been deleted');
            loadActiveOrders();
            loadOrderHistory();
            updateStats();
        } catch (error) {
            showNotification('error', 'Clear Failed', 'Could not clear database');
        }
    }
    
    function testNotification() {
        const types = ['success', 'error', 'warning', 'info'];
        const type = types[Math.floor(Math.random() * types.length)];
        showNotification(type, 'Test Notification', 'This is a test notification to check the notification system.');
    }
</script>

</body>
</html>
