<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo | Admin Panel</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Your existing HTML structure -->
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
            authDomain: "easygo-10f4b.firebaseapp.com",
            projectId: "easygo-10f4b",
            storageBucket: "easygo-10f4b.firebasestorage.app",
            messagingSenderId: "197660067542",
            appId: "1:197660067542:web:6c616efb479b122f1f6b77",
            databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        
        let database;
        let isFirebaseConnected = false;
        
        function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    isFirebaseConnected = snap.val() === true;
                });
            } catch (error) {
                console.error("Firebase error:", error);
            }
        }
        
        // Real-time order listener
        function setupOrderListener() {
            if (!isFirebaseConnected) return;
            
            // Listen for new orders
            database.ref('orders').orderByChild('status').equalTo('pending')
                .on('child_added', function(snapshot) {
                    const order = snapshot.val();
                    console.log("New order received:", order);
                    // Update admin UI
                    addNewOrderToUI(order, snapshot.key);
                });
            
            // Listen for order updates
            database.ref('orders').on('child_changed', function(snapshot) {
                const order = snapshot.val();
                console.log("Order updated:", order);
                // Update admin UI
                updateOrderInUI(order, snapshot.key);
            });
        }
        
        // Update order status in Firebase
        async function updateOrderStatusInFirebase(orderId, status, updateData = {}) {
            if (!isFirebaseConnected) return false;
            
            try {
                await database.ref(`orders/${orderId}`).update({
                    status: status,
                    updatedAt: Date.now(),
                    ...updateData
                });
                return true;
            } catch (error) {
                console.error("Error updating order status:", error);
                return false;
            }
        }
        
        // Get active orders
        async function getActiveOrdersFromFirebase() {
            if (!isFirebaseConnected) return [];
            
            try {
                const snapshot = await database.ref('orders')
                    .orderByChild('status')
                    .startAt('pending')
                    .endAt('out-for-delivery')
                    .once('value');
                
                return snapshot.val() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
            } catch (error) {
                console.error("Error getting orders:", error);
                return [];
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            // After login, setup real-time listeners
            function loginAdmin() {
                // Your existing login logic
                
                // Setup Firebase listeners
                if (isFirebaseConnected) {
                    setupOrderListener();
                    loadOrdersFromFirebase();
                }
            }
            
            // Load orders from Firebase
            async function loadOrdersFromFirebase() {
                const orders = await getActiveOrdersFromFirebase();
                // Update your UI with orders
                renderOrders(orders);
            }
            
            // Update your existing status update functions
            function updateOrderStatus(orderId, status) {
                // Your existing UI update logic
                
                // Update in Firebase
                updateOrderStatusInFirebase(orderId, status, {
                    updatedBy: 'admin',
                    updatedByName: 'Admin User'
                });
            }
        });
    </script>
</body>
</html>
